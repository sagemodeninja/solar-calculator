<!DOCTYPE html>
<html>
    <head>
        <style>
            .custom_radio {
                border: solid 1px #bdbdbd;
                -webkit-border-radius: 5px;
                -moz-border-radius: 5px;
                border-radius: 5px;
                display: inline-block;
                font-family: sans-serif;
                padding: 1px;
            }
        
            .custom_radio input {
                display: none;
            }
        
            .custom_radio label {
                cursor: pointer;
                display: inline-block;
                height: 23px;
                line-height: 23px;
                font-size: 13px;
                margin: 0;
                padding: 0 10px;
            }
        
            .custom_radio label.active {
                background-color: #3f51b5;
                -webkit-border-radius: 4px;
                -moz-border-radius: 4px;
                border-radius: 4px;
                color: #ffffff;
                font-weight: bold;
            }
        </style>
    </head>
    <body>
        <h1>Solar Calculator</h1>
        <table>
            <tr>
                <td>Solar Wattage:</td>
                <td>
                    <input id="solar_wattage" placeholder="Solar Wattage (Watts)">
                </td>
            </tr>
            <tr>
                <td>Controller Type:</td>
                <td>
                    <div class="custom_radio">
                        <label for="controller_type_0" class="active">PWM</label>
                        <label for="controller_type_1">MPPT</label>
                        <input type="radio" name="controller_type" id="controller_type_0" value="0.75" checked>
                        <input type="radio" name="controller_type" id="controller_type_1" value="0.95">
                    </div>
                </td>
            </tr>
            <tr>
                <td>Appliance Load:</td>
                <td>
                    <select id="app_load_type">
                        <option value="0">Watts</option>
                        <option value="1">Volts + Ampere</option>
                    </select>
                    <input id="app_load" placeholder="Load (Watts)">
                    <input id="app_volts" placeholder="Load Voltage (v)" hidden>
                    <input id="app_ampere" placeholder="Load Ampere (A)" hidden>
                    <label id="app_load_preview" hidden>0 Watts<label>
                </td>
            </tr>
            <tr>
                <td>Battery Type:</td>
                <td>
                    <div class="custom_radio">
                        <label for="batt_type_0" class="active">Deep Cycle/Lead Acid</label>
                        <label for="batt_type_1">LifePo4</label>
                        <input type="radio" name="batt_type" id="batt_type_0" value="0" checked>
                        <input type="radio" name="batt_type" id="batt_type_1" value="1">
                    </div>
                </td>
            </tr>
            <tr>
                <td>Battery Volts:</td>
                <td>
                    <input id="batt_volts" placeholder="Battery Voltage (v)">
                </td>
            </tr>
            <tr>
                <td>Battery Capacity:</td>
                <td>
                    <input id="batt_capacity" placeholder="Battery Capacity (Ah)">
                </td>
            </tr>
            <tr>
                <td>Use Duration:</td>
                <td>
                    <input id="use_duration" placeholder="Use Duration" readonly>
                </td>
            </tr>
            </tr>
            <tr>
                <td>Charge Duration:</td>
                <td>
                    <input id="charge_duration" placeholder="Charge Duration" readonly>
                </td>
            </tr>
            <tr>
                <td colspan="2">
                    <button type="button" id="calc_btn">Calculate</button>
                </td>
            </tr>
        </table>
        
        <script>
            var solarWattageIpt;
            var controllerTypeRads;
            var appLoadTypeSlct;
            var appLoadIpt;
            var appVoltsIpt;
            var appAmpereIpt;
            var appLoadLbl;
            var battTypeRads;
            var battVoltsIpt;
            var battCapacityIpt;
            var useDurationIpt;
            var chargeDurationIpt;
            var calcBtn;
        
            document.addEventListener("DOMContentLoaded", e => {
                solarWattageIpt = document.querySelector("#solar_wattage");
                controllerTypeRads = document.querySelectorAll("input[name=controller_type]");
                appLoadTypeSlct = document.querySelector("#app_load_type");
                appLoadIpt = document.querySelector("#app_load");
                appVoltsIpt = document.querySelector("#app_volts");
                appAmpereIpt = document.querySelector("#app_ampere");
                appLoadLbl = document.querySelector("#app_load_preview");
                battTypeRads = document.querySelectorAll("input[name=batt_type]");
                battVoltsIpt = document.querySelector("#batt_volts");
                battCapacityIpt = document.querySelector("#batt_capacity");
                useDurationIpt = document.querySelector("#use_duration");
                chargeDurationIpt = document.querySelector("#charge_duration");
                calcBtn = document.querySelector("#calc_btn");
        
                var controllerEfficiency;
                var battDoD;
                var battChargeEfficiency;

                initCustomRadio(controllerTypeRads, value => controllerEfficiency = parseFloat(value));
                initCustomRadio(battTypeRads, value => {
                    var isDeepCycle = parseFloat(value) == 0;
                    battDoD = isDeepCycle ? 0.5 : 0.95;
                    battChargeEfficiency = isDeepCycle ? 0.85 : 0.95;
                });

                appLoadTypeSlct.addEventListener("change", e =>{
                    var apptype = parseInt(appLoadTypeSlct.value);
        
                    if(apptype == 0) {
                        appLoadIpt.removeAttribute("hidden");
                        appVoltsIpt.setAttribute("hidden", true);
                        appAmpereIpt.setAttribute("hidden", true);
                        appLoadLbl.setAttribute("hidden", true);
                    } else {
                        appLoadIpt.setAttribute("hidden", true);
                        appVoltsIpt.removeAttribute("hidden");
                        appAmpereIpt.removeAttribute("hidden");
                        appLoadLbl.removeAttribute("hidden");
                    }
                });
        
                appVoltsIpt.addEventListener("input", calculateAppLoadFromVoltsAndAmpere);
                appAmpereIpt.addEventListener("input", calculateAppLoadFromVoltsAndAmpere)
        
                calcBtn.addEventListener("click", e => {
                    var appType = parseInt(appLoadTypeSlct.value);
                    var appVolts = parseFloat(appVoltsIpt.value);
                    var appAmpere = parseFloat(appAmpereIpt.value);
                    var appLoad = appType == 0 ? parseFloat(appLoadIpt.value) : appVolts * appAmpere;
                    var battVolts = parseFloat(battVoltsIpt.value);
                    var battCapacity = parseFloat(battCapacityIpt.value);
        
                    var totalBattWatts = battVolts * battCapacity * battDoD;
                    var useDuration = totalBattWatts / appLoad;
        
                    var solarWattage = parseFloat(solarWattageIpt.value);
                    var controllerMaxCurrentOutput = solarWattage / battVolts;
                    var realMaxCurrentOutput = controllerMaxCurrentOutput * (1 - 0.2) * controllerEfficiency;
                    var realMaxBattCharge = battCapacity * (1 / battChargeEfficiency);
                    var chargeDuration = (realMaxBattCharge / realMaxCurrentOutput) * battDoD + 2;
                    
                    useDurationIpt.value = getFullTimeFromHours(useDuration);
                    chargeDurationIpt.value = getFullTimeFromHours(chargeDuration);
                });
            });
        
            function calculateAppLoadFromVoltsAndAmpere(){
                var appVolts = parseFloat(appVoltsIpt.value || "0");
                var appAmpere = parseFloat(appAmpereIpt.value || "0");
                var appLoad = appVolts * appAmpere;
        
                appLoadLbl.innerText = `${appLoad} Watts`;
            }
        
            function getFullTimeFromHours(hours) {
                var minutes = (hours * 60) % 60;
                var seconds = (minutes * 60) % 60;
        
                return chargeDurationIpt.value = `${Math.floor(hours)}h ${Math.floor(minutes)}m ${Math.ceil(seconds)}s (${hours.toFixed(2)})`;
            }

            function initCustomRadio(radios, callback) {
                radios.forEach(radio => {
                    radio.addEventListener("change", e => {
                        let value;

                        radios.forEach(subRadio => {
                            let label = document.querySelector(`label[for=${subRadio.id}]`);
                            
                            if(subRadio.checked) {
                                value = subRadio.value;
                                label.classList.add("active");
                            } else {
                                label.classList.remove("active");
                            }
                        });
        
                        if(callback)
                            callback(value);
                    });
                });
            }
        </script>
    </body>
</html>